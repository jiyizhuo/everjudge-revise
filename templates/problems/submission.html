{% extends "base.html" %}
{% block title %}提交结果 - EverJudge{% endblock %}
{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- 页面头部 -->
    <div class="mb-6">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <div>
                <h1 class="text-2xl font-bold text-slate-800 dark:text-white">提交结果</h1>
                <div class="flex items-center gap-4 mt-2">
                    <span class="text-slate-600 dark:text-slate-400">提交 #{{ submission.id }}</span>
                    <span class="text-slate-600 dark:text-slate-400">{{ submission.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</span>
                </div>
            </div>
            <div class="flex gap-3">
                <a href="{{ url_for('problems.detail', id=submission.problem_id) }}" class="inline-flex items-center px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                    查看题目
                </a>
                <a href="{{ url_for('problems.submissions') }}" class="inline-flex items-center px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                    提交历史
                </a>
            </div>
        </div>
    </div>
    
    <!-- 提交状态 -->
    <div class="rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 p-6 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- 题目信息 -->
            <div>
                <h3 class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">题目</h3>
                <p class="text-slate-800 dark:text-slate-200">
                    <a href="{{ url_for('problems.detail', id=submission.problem_id) }}" class="text-primary hover:underline">
                        {{ submission.problem.title }}
                    </a>
                </p>
            </div>
            
            <!-- 提交者 -->
            <div>
                <h3 class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">提交者</h3>
                <p class="text-slate-800 dark:text-slate-200">{{ submission.user.username }}</p>
            </div>
            
            <!-- 编程语言 -->
            <div>
                <h3 class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">编程语言</h3>
                <p class="text-slate-800 dark:text-slate-200">{{ submission.language }}</p>
            </div>
            
            <!-- 评测状态 -->
            <div>
                <h3 class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">评测状态</h3>
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium {% if submission.status == 'ACCEPTED' %}bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400{% elif submission.status == 'WRONG_ANSWER' %}bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400{% elif submission.status == 'TIME_LIMIT_EXCEEDED' %}bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400{% elif submission.status == 'MEMORY_LIMIT_EXCEEDED' %}bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400{% elif submission.status == 'RUNTIME_ERROR' %}bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-400{% elif submission.status == 'COMPILATION_ERROR' %}bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400{% else %}bg-slate-100 text-slate-800 dark:bg-slate-800/50 dark:text-slate-400{% endif %}">
                    {% if submission.status == 'ACCEPTED' %}通过{% elif submission.status == 'WRONG_ANSWER' %}答案错误{% elif submission.status == 'TIME_LIMIT_EXCEEDED' %}时间超限{% elif submission.status == 'MEMORY_LIMIT_EXCEEDED' %}内存超限{% elif submission.status == 'RUNTIME_ERROR' %}运行错误{% elif submission.status == 'COMPILATION_ERROR' %}编译错误{% elif submission.status == 'PENDING' %}等待评测{% elif submission.status == 'RUNNING' %}正在评测{% else %}系统错误{% endif %}
                </span>
            </div>
        </div>
        
        <!-- 评测详情 -->
        {% if submission.status not in ['PENDING', 'RUNNING'] %}
        <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- 得分 -->
            <div>
                <h3 class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">得分</h3>
                <p class="text-2xl font-bold text-slate-800 dark:text-slate-200">{{ submission.score }}</p>
            </div>
            
            <!-- 执行时间 -->
            <div>
                <h3 class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">执行时间</h3>
                <p class="text-slate-800 dark:text-slate-200">
                    {% if submission.execution_time %}
                    {{ submission.execution_time }}ms
                    {% else %}
                    -  
                    {% endif %}
                </p>
            </div>
            
            <!-- 内存使用 -->
            <div>
                <h3 class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">内存使用</h3>
                <p class="text-slate-800 dark:text-slate-200">
                    {% if submission.memory_used %}
                    {{ "%.2f"|format(submission.memory_used / 1024) }}MB
                    {% else %}
                    -  
                    {% endif %}
                </p>
            </div>
        </div>
        {% endif %}
        
        <!-- 错误信息 -->
        {% if submission.error_message %}
        <div class="mt-6">
            <h3 class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-2">错误信息</h3>
            <div class="p-4 rounded-md bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800">
                <pre class="text-sm text-red-800 dark:text-red-400 overflow-x-auto">{{ submission.error_message }}</pre>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- 代码展示 -->
    <div class="rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 p-6">
        <h2 class="text-lg font-semibold text-slate-800 dark:text-white mb-4">提交的代码</h2>
        <pre class="bg-slate-900 text-slate-100 p-4 rounded-md overflow-x-auto font-mono text-sm">{{ submission.code }}</pre>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 自动刷新评测状态
    document.addEventListener('DOMContentLoaded', function() {
        const statusElement = document.querySelector('.rounded-full');
        const status = statusElement.textContent.trim();
        
        if (status === '等待评测' || status === '正在评测') {
            const submissionId = {{ submission.id }};
            
            function updateStatus() {
                fetch(`{{ url_for('problems.submission_status', id=submission.id) }}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            console.error('获取状态失败:', data.error);
                            return;
                        }
                        
                        // 更新状态显示
                        let statusText = '';
                        let statusClass = '';
                        
                        switch(data.status) {
                            case 'ACCEPTED':
                                statusText = '通过';
                                statusClass = 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400';
                                break;
                            case 'WRONG_ANSWER':
                                statusText = '答案错误';
                                statusClass = 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400';
                                break;
                            case 'TIME_LIMIT_EXCEEDED':
                                statusText = '时间超限';
                                statusClass = 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400';
                                break;
                            case 'MEMORY_LIMIT_EXCEEDED':
                                statusText = '内存超限';
                                statusClass = 'bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400';
                                break;
                            case 'RUNTIME_ERROR':
                                statusText = '运行错误';
                                statusClass = 'bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-400';
                                break;
                            case 'COMPILATION_ERROR':
                                statusText = '编译错误';
                                statusClass = 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400';
                                break;
                            case 'PENDING':
                                statusText = '等待评测';
                                statusClass = 'bg-slate-100 text-slate-800 dark:bg-slate-800/50 dark:text-slate-400';
                                break;
                            case 'RUNNING':
                                statusText = '正在评测';
                                statusClass = 'bg-slate-100 text-slate-800 dark:bg-slate-800/50 dark:text-slate-400';
                                break;
                            default:
                                statusText = '系统错误';
                                statusClass = 'bg-slate-100 text-slate-800 dark:bg-slate-800/50 dark:text-slate-400';
                        }
                        
                        statusElement.textContent = statusText;
                        statusElement.className = `inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${statusClass}`;
                        
                        // 如果评测完成，停止刷新
                        if (data.status !== 'PENDING' && data.status !== 'RUNNING') {
                            clearInterval(interval);
                            // 刷新页面以获取完整结果
                            setTimeout(() => {
                                window.location.reload();
                            }, 1000);
                        }
                    })
                    .catch(error => {
                        console.error('请求失败:', error);
                    });
            }
            
            // 每2秒刷新一次
            const interval = setInterval(updateStatus, 2000);
            
            // 初始刷新
            updateStatus();
        }
    });
</